# 2024-12-11 Books DB & Books CRUD contracts

## Валидация
1. Книга не может быть без автора - проверить, что авторов в добавляемой книге > 1
2. Определить максимальную длину строк в полях книги, автора и ограничить
3.  Валидация должна быть на уровне базы, на уровне бэка и на уровне фронта


## Что проверить/посмотреть?
1. Как хранить язык книги - enum в виде строки (если это пофиксили)
2. [Доклад про B-Tree индекс](https://www.youtube.com/watch?v=y-Wtyvme4gE)
3. Как сейчас реализовано удаление книг? Если удалить книгу, удалится ли автор? Если удалить автора, удалится ли книга?
4. Как возвращаем сообщение об ошибке? (RFC?)
5. Краткие коды языков для контрактов по книжкам ("eng" скорее всего может быть просто "e")


## Улучшения, изменения
1. Используем только такие HTTP методы: GET, POST, DELETE. Не используем PUT
2. Меняем url по примеру:
/api/books - POST создает
/api/books/1/edit - POST
/api/books/1/soft-delete - DELETE
/api/books/1/hard-delete - DELETE
/api/books - GET - все
/api/books/1 - GET - одна книга
/api/books/1/authors - GET
3. При создании книги возвращаем { "newBookId": 1 }
4. При удалении возвращаем { “isDeleted”: true }, потому что Cypress для тестов на фронте нужно что-то возвращать для эндпоинта удаления
5. При многократном удалении одного и того же результата не возвращаем ошибку, а только { “isDeleted”: true } - идемпотентность
6. Написать E2E на Karate для всех CRUD операций
7. Прописать в контрактах все респонсы
8. Реализовать редактирование для всех полей, в т.ч. автор, язык
9. Добавить примеры значений полей в базе данных (чтобы было понятно, какие данные лежат в реальной используемой таблице - отразить в диаграмме в виде дополнительной таблицы (или если можно - в ней же, если есть такой функционал))
10. Добавить все поля, которых не хватает в доке, но они уже есть в реализации: tenant_id, deleted_at_utc и т.д.

## Каких контрактов не хватает?
1. Запрос на одну книгу (по id)


## Вопросы
1. Откуда берем обложку? (наш s3 или картинки из тянем из интернета) - посоветоваться по лицензиям и возможностям с Настей, поискать инфу самим


## Что обсуждали еще:
1) Заинлайнить имя автора в таблицу с книгами или вынести в отдельную таблицу?
   За "заинлайнить": 
   - не надо будет реализовывать каскадное удаление/редактирование при удалении/редактировании книги
   - мало кто пишет больше 1 книги из технических авторов, словарь с авторами **для нашей** библиотеки не будет часто переиспользоваться

   За "вынести в отдельную таблицу":
   - Если будет фича выбора автора из списка так будет проще реализовать
   - При поиске автора через поисковую строку не будем зависеть от провайдера БД

   Пока что оставили с отдельной таблицей, нужно написать ADR и рассмотреть кейсы из раздела `Кейсы на рассмотрение`, чтобы принять окончательное решение.

### Кейсы на рассмотрение (привести примеры запросов, ответов):
Дано:
- "Первый Демон"
- "Второй Парень"
- "Третий Третий"

Кейс 1: Хочу поправить опечатку в первом авторе: "Первый Первый"

Кейс 2: "Второй Парень" хочу удалить (добавлено случайно)

Кейс 3: Хочу добавить нового автора: "Четвертый Четвертый

Кейс 4: Автора "Третий Третий" оставляем без изменений

Кейс 5: Что произойдет когда удалим/переименуем автора, который: 1) есть в нескольких книгах; 2) есть только в одной книге


## Домашнее задание
Найти в Tech-канале обсуждение Саши и Игоря по datetime в PostgreSQL, почитать его и почитать статью к этому обсуждению. После этого сможем обсудить какой в итоге тип у created_at_utc и deleted_at_utc.


> Следующий Quality time будет о том, как писать тесты на бэкенде по TDD.
